#!/command/with-contenv bash

source /assets/functions/00-container
source /assets/defaults/10-openldap

# Usage: /usr/local/bin/slapd-restore dbnum file
dbnum=$1
file=$2

backupPath="/data/backup"
file="$backupPath/$file"

# stop slapd
s6-svc -d /var/run/s6/legacy-services/10-openldap
pkill slapd

TEMP_FILE=$(mktemp)
gunzip -c $file > $TEMP_FILE
chown ldap:ldap $TEMP_FILE

if [ "$1" = "0" ]; then
	rm -rf ${CONFIG_PATH}/slap.d/*
fi

if [ "$1" = "1" ]; then
	rm -rf ${DB_PATH}/*
fi

sudo -u ldap slapadd -c -F /etc/openldap/slapd.d -n $dbnum -l $TEMP_FILE

# restart slapd
s6-svc -u /var/run/s6/legacy-services/10-openldap

rm $TEMP_FILE

exit 0
